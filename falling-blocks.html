<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Read the Sentence ‚Äî Word by Word</title>
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body {
      background: radial-gradient(1200px 700px at 50% 0%, rgba(120,180,255,0.18), rgba(0,0,0,0)) , #0b1220;
      color: #e9eefc;
      display: grid;
      place-items: center;
      padding: 14px;
    }

    .app {
      width: min(980px, 100%);
      display: grid;
      gap: 14px;
      grid-template-columns: 1.25fr 0.75fr;
      align-items: start;
    }
    @media (max-width: 900px) { .app { grid-template-columns: 1fr; } }

    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: 0 12px 34px rgba(0,0,0,0.35);
      overflow: hidden;
    }

    .header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }

    .title { display: grid; gap: 2px; }
    .title h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; }
    .title p { font-size: 12px; margin: 0; opacity: 0.8; }

    .btns { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    button, select {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: #e9eefc;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 13px;
    }
    button:hover { background: rgba(255,255,255,0.16); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    select { cursor: pointer; }

    .main { padding: 14px; display: grid; gap: 14px; }

    .sentenceBox {
      border-radius: 16px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 14px;
      display: grid;
      gap: 12px;
    }

    .label { font-size: 12px; opacity: 0.82; }

    .words {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      padding: 6px 0 2px;
    }

    .word {
      min-width: 56px;
      padding: 12px 14px;
      border-radius: 14px;
      text-align: center;
      font-size: clamp(18px, 4.7vw, 26px);
      font-weight: 900;
      letter-spacing: 0.4px;
      user-select: none;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      transition: transform 220ms ease, background 220ms ease, border-color 220ms ease;
      text-transform: lowercase;
    }

    .word.pending { opacity: 0.92; }
    .word.current {
      background: rgba(120,180,255,0.22);
      border-color: rgba(120,180,255,0.35);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 10px 16px rgba(0,0,0,0.18);
    }
    .word.correct {
      background: rgba(60,255,160,0.14);
      border-color: rgba(60,255,160,0.38);
    }
    .word.wrongFlash {
      background: rgba(255,80,120,0.18);
      border-color: rgba(255,80,120,0.42);
      transform: translateY(0) scale(1.02);
    }

    .status {
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size: 14px;
    }
    .status.ok { border-color: rgba(60,255,160,0.35); background: rgba(60,255,160,0.10); }
    .status.bad { border-color: rgba(255,80,120,0.35); background: rgba(255,80,120,0.10); }
    .status.neutral { opacity: 0.95; }

    .small { font-size: 12px; opacity: 0.82; text-align: center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .stat {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      text-align: center;
    }
    .stat .k { font-size: 11px; opacity: 0.8; }
    .stat .v { font-size: 18px; font-weight: 900; margin-top: 2px; }

    .warn {
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,190,60,0.28);
      background: rgba(255,190,60,0.10);
      font-size: 13px;
      line-height: 1.35;
      margin: 12px 14px 14px;
      display: none;
    }

    /* Reward panel */
    .rewardWrap { height: 560px; padding: 14px; display: grid; gap: 14px; grid-template-rows: auto 1fr auto; }
    .rewardStage {
      border-radius: 16px;
      background:
        radial-gradient(700px 400px at 50% 20%, rgba(255,255,255,0.12), rgba(0,0,0,0)),
        rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.12);
      position: relative;
      overflow: hidden;
      display: grid;
      place-items: center;
    }

    .rewardEmoji {
      font-size: 96px;
      filter: drop-shadow(0 18px 24px rgba(0,0,0,0.35));
      opacity: 0;
      transform: translateY(14px) scale(0.9);
      transition: opacity 220ms ease, transform 220ms cubic-bezier(.2,.9,.2,1);
      user-select: none;
      text-align: center;
      line-height: 1.1;
      padding: 10px;
    }
    .rewardEmoji.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      animation: bounce 900ms ease-out 1;
    }
    @keyframes bounce {
      0% { transform: translateY(18px) scale(0.92); }
      45% { transform: translateY(-10px) scale(1.02); }
      75% { transform: translateY(6px) scale(0.98); }
      100% { transform: translateY(0) scale(1); }
    }

    .rewardCaption {
      font-size: 14px;
      opacity: 0.9;
      text-align: center;
      padding: 0 10px 10px;
    }

    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      opacity: 0;
      transition: opacity 180ms ease;
    }
    .confetti.on { opacity: 1; }
    .confetto {
      position: absolute;
      top: -12px;
      width: 10px;
      height: 16px;
      border-radius: 3px;
      background: rgba(255,255,255,0.8);
      opacity: 0.95;
      animation: fall 1100ms linear forwards;
      transform: rotate(12deg);
    }
    @keyframes fall {
      to { top: 110%; transform: rotate(260deg); opacity: 0.95; }
    }

    .footerNote { font-size: 11px; opacity: 0.78; text-align: center; padding: 0 14px 14px; }

    .row {
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <div class="title">
          <h1>Read the Sentence</h1>
          <p>Read each word in order. Words turn green when correct. Finish the sentence to unlock an animated reward.</p>
        </div>
        <div class="btns">
          <button id="btnStart">üéôÔ∏è Start</button>
          <button id="btnStop" disabled>‚èπ Stop</button>
          <button id="btnHint">üîä Say Word</button>
          <button id="btnRestartWord">‚Ü©Ô∏è Retry Word</button>
          <button id="btnNext">‚û°Ô∏è Next</button>
          <button id="btnReset">üîÑ Reset</button>
        </div>
      </div>

      <div class="main">
        <div class="sentenceBox">
          <div class="row">
            <div class="label">Choose sentence:</div>
            <select id="sentencePicker" aria-label="Sentence picker"></select>
          </div>

          <div class="label">Read this sentence (word-by-word):</div>
          <div class="words" id="words"></div>

          <div class="status neutral" id="status">
            Press <b>Start</b>, then read the <b>blue</b> word.
          </div>
          <div class="small">Heard: <span class="mono" id="heard">‚Äî</span></div>
        </div>

        <div class="stats">
          <div class="stat"><div class="k">Word</div><div class="v" id="wordIndex">1</div></div>
          <div class="stat"><div class="k">Correct words</div><div class="v" id="correctWords">0</div></div>
          <div class="stat"><div class="k">Attempts</div><div class="v" id="attempts">0</div></div>
        </div>
      </div>

      <div class="warn" id="supportWarn">
        Your browser doesn‚Äôt support <b>Web Speech Recognition</b>.
        Try <b>Chrome</b> on desktop or Android. On iOS, speech recognition support can be limited.
      </div>

      <div class="footerNote">
        Privacy note: Speech recognition may use the browser‚Äôs speech service. Don‚Äôt use for sensitive info.
      </div>
    </div>

    <div class="card">
      <div class="header">
        <div class="title">
          <h1>Reward</h1>
          <p>Finish the whole sentence to see a fun animated scene.</p>
        </div>
        <div class="btns">
          <button id="btnReplayReward">üéâ Replay</button>
          <button id="btnMute">üîà Sound On</button>
        </div>
      </div>

      <div class="rewardWrap">
        <div class="rewardStage" id="rewardStage">
          <div class="confetti" id="confetti"></div>
          <div>
            <div class="rewardEmoji" id="rewardEmoji">üôÇ</div>
            <div class="rewardCaption" id="rewardCaption">Read the sentence to unlock!</div>
          </div>
        </div>
        <div class="small">Tip: If recognition is picky, speak slowly and clearly.</div>
        <div class="small">Best in Chrome/Edge.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ------------------ Dictionary (1‚Äì4 letter words only) ------------------
  // Note: "the" is 3 letters, allowed. Sentences are simple & kid-friendly.
  const DICT = [
    { id: "s1", text: "I see a cat", reward: { emoji: "üëÄüê±‚ú®", caption: "A cat pops in with sparkles!" } },
    { id: "s2", text: "The sun is up", reward: { emoji: "‚òÄÔ∏èüå§‚ú®", caption: "The sun rises ‚Äî yay!" } },
    { id: "s3", text: "We can run", reward: { emoji: "üèÉ‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÄÔ∏èüí®", caption: "Run run run!" } },
    { id: "s4", text: "The dog is sad", reward: { emoji: "üê∂üò¢", caption: "Oh no ‚Äî a sad pup." } },
    { id: "s5", text: "I see the red bus", reward: { emoji: "üöåüî¥‚ú®", caption: "A red bus zooms by!" } },
    { id: "s6", text: "The hen has an egg", reward: { emoji: "üêîü•ö‚ú®", caption: "A hen shows an egg!" } },
    { id: "s7", text: "A bug is on me", reward: { emoji: "üêûüòÑ", caption: "A tiny bug says hi!" } },
    { id: "s8", text: "We see a big fox", reward: { emoji: "üëÄü¶ä‚ú®", caption: "A big fox appears!" } }
  ];

  // ------------------ Elements ------------------
  const elWords = document.getElementById("words");
  const elStatus = document.getElementById("status");
  const elHeard = document.getElementById("heard");
  const elWordIndex = document.getElementById("wordIndex");
  const elCorrectWords = document.getElementById("correctWords");
  const elAttempts = document.getElementById("attempts");
  const elWarn = document.getElementById("supportWarn");

  const picker = document.getElementById("sentencePicker");

  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnHint = document.getElementById("btnHint");
  const btnRestartWord = document.getElementById("btnRestartWord");
  const btnNext = document.getElementById("btnNext");
  const btnReset = document.getElementById("btnReset");
  const btnReplayReward = document.getElementById("btnReplayReward");
  const btnMute = document.getElementById("btnMute");

  const rewardEmoji = document.getElementById("rewardEmoji");
  const rewardCaption = document.getElementById("rewardCaption");
  const confetti = document.getElementById("confetti");

  // ------------------ Speech Recognition ------------------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let listening = false;
  let manualStop = false;

  // ------------------ State ------------------
  let currentIdx = 0;
  let attempts = 0;
  let correctCount = 0;
  let unlocked = false;

  let soundOn = true;

  let currentSentence = DICT[0];
  let words = tokenize(currentSentence.text);

  // ------------------ Helpers ------------------
  function setStatus(type, html) {
    elStatus.className = `status ${type}`;
    elStatus.innerHTML = html;
  }

  function normalize(s) {
    return (s || "")
      .toLowerCase()
      .trim()
      .replace(/[^a-z\s']/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function tokenize(sentence) {
    return normalize(sentence).split(" ").filter(Boolean);
  }

  function renderPicker() {
    picker.innerHTML = "";
    DICT.forEach((s, idx) => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${idx + 1}. ${s.text}`;
      picker.appendChild(opt);
    });
    picker.value = currentSentence.id;
  }

  function renderWords() {
    elWords.innerHTML = "";
    words.forEach((w, i) => {
      const span = document.createElement("div");
      span.className = "word pending";
      span.textContent = w;
      span.dataset.idx = String(i);
      elWords.appendChild(span);
    });
    updateWordClasses();
  }

  function updateWordClasses(flashWrong=false) {
    [...elWords.children].forEach((node, i) => {
      node.classList.remove("current", "correct", "wrongFlash");
      if (i < currentIdx) node.classList.add("correct");
      else node.classList.add("pending");

      if (i === currentIdx && !unlocked) node.classList.add("current");
    });

    if (flashWrong) {
      const node = elWords.children[currentIdx];
      if (node) {
        node.classList.add("wrongFlash");
        setTimeout(() => node.classList.remove("wrongFlash"), 260);
      }
    }

    elWordIndex.textContent = String(Math.min(currentIdx + 1, words.length));
    elCorrectWords.textContent = String(correctCount);
    elAttempts.textContent = String(attempts);
  }

  function ensureRecognition() {
    if (!SpeechRecognition) {
      elWarn.style.display = "block";
      btnStart.disabled = true;
      btnStop.disabled = true;
      return false;
    }
    if (!rec) {
      rec = new SpeechRecognition();
      rec.lang = "en-US";
      rec.interimResults = false;
      rec.continuous = true;
      rec.maxAlternatives = 3;

      rec.onstart = () => {
        listening = true;
        btnStart.disabled = true;
        btnStop.disabled = false;
        if (!unlocked) {
          setStatus("neutral", `üéôÔ∏è Listening... Say: <b>${words[currentIdx]}</b>`);
        }
      };

      rec.onend = () => {
        listening = false;
        btnStart.disabled = false;
        btnStop.disabled = true;
        if (!manualStop) {
          try { rec.start(); } catch (_) {}
        }
      };

      rec.onerror = (e) => {
        setStatus("bad", `‚ö†Ô∏è Speech error: <b>${e.error}</b>. If blocked, allow microphone permission.`);
      };

      rec.onresult = (evt) => {
        const res = evt.results[evt.results.length - 1];
        const best = res && res[0] ? res[0].transcript : "";
        const norm = normalize(best);
        elHeard.textContent = norm || "‚Äî";

        if (!norm || unlocked) return;

        attempts++;

        const target = words[currentIdx];
        const ok = wordMatches(norm, target);

        if (ok) {
          correctCount++;
          playGoodWord();
          setStatus("ok", `‚úÖ Correct! You said: <b>${escapeHtml(best)}</b>`);
          currentIdx++;
          if (currentIdx >= words.length) {
            unlockReward();
          } else {
            setTimeout(() => {
              setStatus("neutral", `Next word: <b>${words[currentIdx]}</b>`);
            }, 220);
          }
          updateWordClasses();
        } else {
          playBadWord();
          setStatus("bad", `‚ùå Try again. You said: <b>${escapeHtml(best)}</b>`);
          updateWordClasses(true);
        }
      };
    }
    return true;
  }

  // Match strategy for early readers:
  // - exact match OR transcript ends with the word OR contains it as a whole word
  function wordMatches(transcriptNorm, targetWord) {
    const t = normalize(targetWord);
    const s = transcriptNorm;

    if (s === t) return true;

    // whole word match anywhere
    const whole = new RegExp(`\\b${escapeRegExp(t)}\\b`, "i");
    if (whole.test(s)) return true;

    // sometimes recognition returns "the the" etc; accept if it ends with target
    if (s.endsWith(" " + t) || s.endsWith(t)) return true;

    return false;
  }

  function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ------------------ Sounds (no external files) ------------------
  // Uses WebAudio oscillator to make fun tones.
  let audioCtx = null;

  function ensureAudio() {
    if (!soundOn) return null;
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    // iOS requires resume after gesture
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    return audioCtx;
  }

  function beep({ freq=440, dur=0.12, type="sine", gain=0.06, when=0 }) {
    const ctx = ensureAudio();
    if (!ctx) return;

    const t0 = ctx.currentTime + when;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    osc.connect(g);
    g.connect(ctx.destination);

    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }

  function playGoodWord() {
    // cheerful two-tone
    beep({ freq: 660, dur: 0.10, type: "triangle", gain: 0.06 });
    beep({ freq: 880, dur: 0.12, type: "triangle", gain: 0.06, when: 0.10 });
  }

  function playBadWord() {
    // low "boop"
    beep({ freq: 220, dur: 0.16, type: "sawtooth", gain: 0.045 });
  }

  function playSentenceWin() {
    // little fanfare
    const notes = [523, 659, 784, 1046];
    notes.forEach((f, i) => beep({ freq: f, dur: 0.12, type: "square", gain: 0.045, when: i * 0.12 }));
    beep({ freq: 1318, dur: 0.18, type: "triangle", gain: 0.05, when: 0.50 });
  }

  function speakWord(word) {
    // Optional: text-to-speech hint
    try {
      const u = new SpeechSynthesisUtterance(word);
      u.lang = "en-US";
      u.rate = 0.9;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch (_) {}
  }

  // ------------------ Reward animation ------------------
  function clearConfetti() {
    confetti.innerHTML = "";
    confetti.classList.remove("on");
  }

  function popConfetti() {
    clearConfetti();
    confetti.classList.add("on");
    const count = 24;
    for (let i = 0; i < count; i++) {
      const d = document.createElement("div");
      d.className = "confetto";
      d.style.left = (Math.random() * 100) + "%";
      d.style.animationDuration = (900 + Math.random() * 600) + "ms";
      d.style.transform = `rotate(${Math.random()*90}deg)`;
      d.style.opacity = String(0.75 + Math.random()*0.25);
      // random pale-ish colors via rgba (avoid specifying global palette; per-piece is ok)
      const r = Math.floor(120 + Math.random()*135);
      const g = Math.floor(120 + Math.random()*135);
      const b = Math.floor(120 + Math.random()*135);
      d.style.background = `rgba(${r},${g},${b},0.95)`;
      confetti.appendChild(d);
    }
    setTimeout(() => confetti.classList.remove("on"), 1400);
  }

  function showReward() {
    rewardEmoji.textContent = currentSentence.reward.emoji;
    rewardCaption.textContent = currentSentence.reward.caption;
    rewardEmoji.classList.remove("show");
    // force reflow to restart animation
    void rewardEmoji.offsetWidth;
    rewardEmoji.classList.add("show");
    popConfetti();
  }

  function unlockReward() {
    unlocked = true;
    setStatus("ok", `üéâ Sentence complete! Great job!`);
    updateWordClasses();
    showReward();
    playSentenceWin();
  }

  function replayReward() {
    if (!unlocked) return;
    showReward();
    playSentenceWin();
  }

  // ------------------ Flow controls ------------------
  function loadSentenceById(id) {
    const s = DICT.find(x => x.id === id) || DICT[0];
    currentSentence = s;
    words = tokenize(currentSentence.text);
    resetProgress(false);
    renderWords();
    clearConfetti();
    rewardEmoji.textContent = "üôÇ";
    rewardEmoji.classList.remove("show");
    rewardCaption.textContent = "Read the sentence to unlock!";
    setStatus("neutral", `Press <b>Start</b>, then read the <b>blue</b> word.`);
  }

  function resetProgress(resetAttempts=true) {
    currentIdx = 0;
    correctCount = 0;
    if (resetAttempts) attempts = 0;
    unlocked = false;
    elHeard.textContent = "‚Äî";
    updateWordClasses();
  }

  function nextSentence() {
    const idx = DICT.findIndex(x => x.id === currentSentence.id);
    const next = DICT[(idx + 1) % DICT.length];
    picker.value = next.id;
    loadSentenceById(next.id);
  }

  // ------------------ Wire up UI ------------------
  renderPicker();
  renderWords();
  ensureRecognition();

  picker.addEventListener("change", () => loadSentenceById(picker.value));

  btnStart.addEventListener("click", () => {
    if (!ensureRecognition()) return;
    manualStop = false;
    ensureAudio(); // prime audio on gesture
    try { rec.start(); } catch (_) {
      setStatus("bad", `‚ö†Ô∏è Couldn't start listening. If blocked, allow microphone permission.`);
    }
  });

  btnStop.addEventListener("click", () => {
    if (!rec) return;
    manualStop = true;
    try { rec.stop(); } catch (_) {}
    setStatus("neutral", `Stopped. Press <b>Start</b> to continue.`);
  });

  btnHint.addEventListener("click", () => {
    ensureAudio();
    if (unlocked) return;
    const w = words[currentIdx];
    speakWord(w);
  });

  btnRestartWord.addEventListener("click", () => {
    if (unlocked) return;
    elHeard.textContent = "‚Äî";
    setStatus("neutral", `Try again. Say: <b>${words[currentIdx]}</b>`);
    updateWordClasses(true);
  });

  btnNext.addEventListener("click", () => nextSentence());

  btnReset.addEventListener("click", () => {
    resetProgress(true);
    renderWords();
    clearConfetti();
    rewardEmoji.textContent = "üôÇ";
    rewardEmoji.classList.remove("show");
    rewardCaption.textContent = "Read the sentence to unlock!";
    setStatus("neutral", `Press <b>Start</b>, then read the <b>blue</b> word.`);
  });

  btnReplayReward.addEventListener("click", () => replayReward());

  btnMute.addEventListener("click", () => {
    soundOn = !soundOn;
    btnMute.textContent = soundOn ? "üîà Sound On" : "üîá Sound Off";
    if (!soundOn && audioCtx) {
      // keep context but quiet; no need to close
    }
  });

})();
</script>
</body>
</html>
